<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CiLi - Auditoria Urbana</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }
        
        /* Safe Area Support */
        body { 
            padding-top: var(--sat); 
            padding-bottom: var(--sab); 
            background-color: #0f172a; 
            font-family: 'Inter', sans-serif;
        }

        #map { height: 100vh; width: 100%; z-index: 1; border-radius: 0; }

        /* Estiliza√ß√£o do Card de Rede Social no Mapa */
        .leaflet-popup-content-wrapper { border-radius: 28px; padding: 0; overflow: hidden; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        .leaflet-popup-content { margin: 0 !important; width: 280px !important; }
        .leaflet-popup-tip { display: none; }

        /* UI Elements */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.3); }
        .status-pill { font-size: 9px; font-weight: 800; padding: 4px 10px; border-radius: 99px; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-enviado { background: #fee2e2; color: #991b1b; }
        .status-executado { background: #fef3c7; color: #92400e; }
        .status-resolvido { background: #dcfce7; color: #166534; }

        /* Anima√ß√µes */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .btn-like:active { transform: scale(0.9); transition: 0.1s; }
    </style>
</head>
<body class="overflow-hidden">

<div id="app">
    <transition name="fade">
        <div v-if="!user" class="fixed inset-0 z-[10000] glass flex items-center justify-center p-6">
            <div class="bg-white p-8 rounded-[40px] w-full max-w-sm shadow-2xl border border-slate-100">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-black text-slate-900 italic tracking-tighter">CiLi</h1>
                    <p class="text-emerald-500 font-bold text-xs uppercase tracking-widest mt-1">Portal de Transpar√™ncia</p>
                </div>

                <div class="space-y-4">
                    <input v-model="login.email" type="email" placeholder="E-mail do App" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-emerald-500 font-medium">
                    <input v-model="login.password" type="password" placeholder="Senha" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 outline-none focus:border-emerald-500 font-medium">
                    
                    <button @click="handleLogin" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-emerald-600 transition-all shadow-xl shadow-slate-200">
                        ENTRAR NO MAPA
                    </button>

                    <div class="pt-4 text-center">
                        <p class="text-[10px] text-slate-400 font-bold uppercase leading-relaxed">
                            N√£o tem uma conta?<br>
                            <span class="text-slate-800">Crie seu acesso apenas instalando o App CiLi no seu celular.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <div v-if="user" class="relative">
        <div class="fixed top-[calc(var(--sat)+12px)] left-4 right-4 z-[1000] flex flex-col gap-2">
            <div class="glass p-4 rounded-[28px] shadow-lg flex justify-between items-center">
                <div>
                    <h2 class="text-sm font-black text-slate-800 uppercase italic">Auditoria Ativa</h2>
                    <p class="text-[9px] font-bold text-emerald-600 uppercase">{{ entry.city }}</p>
                </div>
                <button @click="showFilters = !showFilters" class="bg-slate-900 text-white px-5 py-2 rounded-full text-[10px] font-black uppercase tracking-tight">
                    {{ showFilters ? 'Fechar' : 'Filtros ‚ò∞' }}
                </button>
            </div>

            <transition name="fade">
                <div v-if="showFilters" class="glass p-3 rounded-[24px] shadow-xl flex gap-2 overflow-x-auto no-scrollbar">
                    <button v-for="s in statusOptions" :key="s.val" @click="filters.status = s.val"
                            :class="['px-5 py-2.5 rounded-full text-[10px] font-black whitespace-nowrap transition-all', filters.status === s.val ? 'bg-emerald-500 text-white' : 'bg-white text-slate-500']">
                        {{ s.label }}
                    </button>
                </div>
            </transition>
        </div>

        <div id="map"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
    const { createApp } = Vue;
    // CONFIGURA√á√ÉO REAL DO SEU PROJETO
    const supabaseClient = supabase.createClient('https://ngjuarfnlepwmvzmkukw.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nanVhcmZubGVwd212em1rdWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjI4NzcsImV4cCI6MjA4NDY5ODg3N30.w67LAEv_D6dn-N2IIGEBKbniwWNdDe7IuBEWptsEqC0');

    const app = createApp({
        data() {
            return {
                user: null,
                login: { email: '', password: '' },
                entry: { city: 'Carregando...' },
                showFilters: false,
                filters: { status: 'aberto' },
                statusOptions: [
                    { label: 'üî¥ Em Aberto', val: 'aberto' },
                    { label: '‚úÖ Resolvidos', val: 'Resolvido' }
                ],
                map: null,
                markerGroup: null
            }
        },
        watch: {
            'filters.status': 'loadReports'
        },
        methods: {
            async handleLogin() {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: this.login.email,
                    password: this.login.password
                });
                
                if (error) {
                    alert("Acesso negado. Use as mesmas credenciais do seu App CiLi.");
                } else {
                    this.user = data.user;
                    this.initDashboard();
                }
            },
            initDashboard() {
                this.$nextTick(() => {
                    this.initMap();
                    this.loadReports();
                });
            },
            initMap() {
                this.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(this.map);
                this.markerGroup = L.featureGroup().addTo(this.map);
            },
            async loadReports() {
                this.markerGroup.clearLayers();
                let query = supabaseClient.from('public_map_reports').select('*');
                
                if(this.filters.status === 'aberto') query = query.in('status', ['Enviado', 'Executado']);
                else query = query.eq('status', 'Resolvido');

                const { data } = await query;
                if(!data || data.length === 0) return;

                this.entry.city = data[0].city;

                data.forEach(r => {
                    const marker = L.marker([r.lat, r.lon]);
                    const popupHTML = `
                        <div class="flex flex-col bg-white">
                            <div class="h-44 bg-slate-100 relative overflow-hidden">
                                <img src="${r.watermarkedUri || 'https://images.unsplash.com/photo-1584467735815-f778f274e296?q=80&w=300&h=200&auto=format&fit=crop'}" class="w-full h-full object-cover">
                                <div class="absolute top-3 left-3">
                                    <span class="status-pill status-${r.status.toLowerCase()} shadow-sm">${r.status}</span>
                                </div>
                            </div>
                            <div class="p-5">
                                <p class="text-[9px] font-black text-slate-400 uppercase mb-1">${new Date(r.createdAt).toLocaleDateString('pt-BR')}</p>
                                <h3 class="font-black text-base text-slate-800 leading-tight mb-4">${r.categoryLabel}</h3>
                                
                                <div class="flex items-center justify-between border-t pt-4">
                                    <button onclick="window.app.giveLike('${r.id}')" class="btn-like flex items-center gap-2 bg-slate-50 border border-slate-100 px-5 py-2.5 rounded-2xl">
                                        <span class="text-base">‚ù§Ô∏è</span>
                                        <span class="text-sm font-black text-slate-700">${r.likes_count || 0}</span>
                                    </button>
                                    
                                    <button onclick="window.app.openAdmin('${r.id}')" class="bg-slate-900 text-white p-2.5 rounded-xl shadow-lg">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupHTML);
                    this.markerGroup.addLayer(marker);
                });
                
                if(data.length > 0) this.map.fitBounds(this.markerGroup.getBounds(), { padding: [60, 60] });
            },
            async giveLike(id) {
                // L√≥gica de Like para Usu√°rio Logado
                const { error } = await supabaseClient.rpc('increment_likes', { row_id: id });
                if(!error) this.loadReports();
            },
            async openAdmin(id) {
                const pass = prompt("Acesso restrito. Digite a senha do gestor:");
                if(pass === "CILI123") {
                    await supabaseClient.from('reports').update({ status: 'Executado' }).eq('id', id);
                    this.loadReports();
                }
            }
        }
    }).mount('#app');
    window.app = app;
</script>
</body>
</html>
