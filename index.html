<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiLi - Painel de Auditoria Urbana</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: calc(100vh - 180px); width: 100%; border-radius: 12px; z-index: 1; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .category-chip { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .category-chip.active { border-color: #10b981; background: #ecfdf5; }
        .status-badge { padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        /* Cores do Sistema */
        .status-enviado { background: #fee2e2; color: #991b1b; } /* Vermelho suave */
        .status-executado { background: #fef3c7; color: #92400e; } /* Laranja */
        .status-resolvido { background: #dcfce7; color: #166534; } /* Verde */
    </style>
</head>
<body class="bg-slate-50 font-sans overflow-hidden">

<div id="app">
    <div v-if="!locationSet" class="modal-overlay">
        <div class="bg-white p-8 rounded-3xl shadow-2xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-black text-slate-800 mb-2 text-center">Fiscaliza√ß√£o CiLi</h2>
            <p class="text-slate-500 text-sm mb-6 text-center">Selecione a regi√£o para auditoria:</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Estado (UF) *</label>
                    <input v-model="entry.uf" placeholder="Ex: SP" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 focus:border-emerald-500 outline-none uppercase">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Cidade *</label>
                    <input v-model="entry.city" placeholder="Ex: Barretos" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 focus:border-emerald-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Bairro (Opcional)</label>
                    <input v-model="entry.neighborhood" placeholder="Ex: Centro" class="w-full border-2 border-slate-100 rounded-xl px-4 py-3 focus:border-emerald-500 outline-none">
                </div>
                <button @click="startDashboard" :disabled="!entry.uf || !entry.city" 
                        class="w-full bg-slate-900 text-white font-black py-4 rounded-xl hover:bg-emerald-600 disabled:opacity-50 transition-colors">
                    ACESSAR MAPA DA CIDADE
                </button>
            </div>
        </div>
    </div>

    <div class="p-4">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
            <div>
                <h1 class="text-xl font-black text-slate-800 uppercase tracking-tighter">
                    CiLi <span class="text-emerald-500">Auditoria Urbana</span>
                </h1>
                <p class="text-[10px] font-bold text-slate-400 uppercase">{{ entry.city }} - {{ entry.uf }}</p>
            </div>

            <div class="flex flex-wrap gap-2">
                <select v-model="filters.status" class="bg-white border-2 border-slate-200 rounded-lg px-3 py-2 text-xs font-bold outline-none focus:border-emerald-500">
                    <option value="aberto">N√ÉO RESOLVIDO (EM ABERTO)</option>
                    <option value="Resolvido">RESOLVIDO</option>
                </select>

                <div class="flex gap-2 overflow-x-auto pb-2">
                    <div v-for="cat in categories" 
                         @click="toggleCategory(cat.label)"
                         :class="['category-chip flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow-sm', filters.category === cat.label ? 'active' : '']">
                        <span class="text-sm">{{ cat.icon }}</span>
                        <span class="text-[10px] font-black uppercase text-slate-600">{{ cat.label }}</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-white p-1 rounded-2xl shadow-md border border-slate-200 overflow-hidden">
            <div id="map"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
    const { createApp } = Vue;
    const supabaseClient = supabase.createClient('SUA_URL', 'SUA_KEY');

    createApp({
        data() {
            return {
                locationSet: false,
                entry: { uf: '', city: '', neighborhood: '' },
                reports: [],
                map: null,
                markers: [],
                filters: { status: 'aberto', category: null },
                categories: [
                    { label: 'Buraco', icon: 'üï≥Ô∏è' },
                    { label: 'Lixo', icon: 'üóëÔ∏è' },
                    { label: 'Ilumina√ß√£o', icon: 'üí°' },
                    { label: 'Mato Alto', icon: 'üå±' },
                    { label: '√Ågua/Esgoto', icon: 'üíß' }
                ]
            }
        },
        watch: {
            'filters.status': 'loadReports',
            'filters.category': 'loadReports'
        },
        methods: {
            async startDashboard() {
                this.locationSet = true;
                this.$nextTick(() => {
                    this.initMap();
                    this.loadReports();
                });
            },
            initMap() {
                this.map = L.map('map').setView([-23.55, -46.63], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                
                // Geocodifica√ß√£o simples: Tenta centralizar na cidade
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${this.entry.city},${this.entry.uf},Brazil`)
                    .then(res => res.json())
                    .then(data => {
                        if(data[0]) this.map.setView([data[0].lat, data[0].lon], 14);
                    });
            },
            toggleCategory(label) {
                this.filters.category = this.filters.category === label ? null : label;
            },
            async loadReports() {
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                let query = supabaseClient.from('public_map_reports').select('*');
                
                // L√≥gica de Filtro 1 (Status)
                if(this.filters.status === 'aberto') {
                    query = query.in('status', ['Enviado', 'Executado']);
                } else {
                    query = query.eq('status', 'Resolvido');
                }

                // L√≥gica de Filtro 2 (Categoria)
                if(this.filters.category) {
                    query = query.eq('categoryLabel', this.filters.category);
                }

                // Filtro de Localidade (Cidade)
                query = query.ilike('city', `%${this.entry.city}%`);

                const { data } = await query;
                this.reports = data || [];

                this.reports.forEach(r => {
                    const marker = L.marker([r.lat, r.lon]).addTo(this.map);
                    marker.bindPopup(`
                        <div class="p-2">
                            <b class="text-slate-800">${r.categoryLabel}</b><br>
                            <span class="status-badge status-${r.status.toLowerCase()}">${r.status}</span>
                            <hr class="my-2">
                            <button onclick="window.app.openAdmin('${r.id}')" class="w-full bg-slate-800 text-white text-[10px] py-1 rounded">GESTOR</button>
                        </div>
                    `);
                    this.markers.push(marker);
                });
            },
            async openAdmin(id) {
                // ... (mesma l√≥gica de senha que voc√™ j√° tem)
                const pass = prompt("Senha Gestor:");
                if(pass === "CILI123") {
                    const res = confirm("Marcar como RESOLVIDO?");
                    if(res) {
                        await supabaseClient.from('reports').update({ status: 'Resolvido' }).eq('id', id);
                        this.loadReports();
                    }
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>
