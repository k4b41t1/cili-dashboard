<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiLi - Painel de Auditoria Urbana</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; border-radius: 12px; z-index: 1; }
        .status-badge { padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-enviado { background: #DBEAFE; color: #1E40AF; }
        .status-aberto { background: #DBEAFE; color: #1E40AF; }
        .status-resolvido { background: #DCFCE7; color: #166534; }
        .status-nao_resolvido { background: #FEE2E2; color: #991B1B; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans">

<div id="app" v-cloak>
    <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-slate-200 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-slate-800">CiLi</h1>
                <p class="text-slate-500 text-sm font-bold uppercase tracking-widest">Acesse com sua conta do App</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">E-mail</label>
                    <input v-model="loginForm.email" type="email" placeholder="seu@email.com" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Senha</label>
                    <input v-model="loginForm.pass" @keyup.enter="handleLogin" type="password" placeholder="******" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
                <button @click="handleLogin" :disabled="loading" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-700 transition disabled:opacity-50">
                    {{ loading ? 'Autenticando...' : 'Entrar no Painel' }}
                </button>
            </div>
        </div>
    </div>

    <div v-else class="max-w-6xl mx-auto p-4">
        <header class="flex justify-between items-center mb-8 py-4">
            <div>
                <h1 class="text-2xl font-black text-slate-800">CiLi <span class="text-emerald-500 text-sm">PAINEL PÚBLICO</span></h1>
                <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">Barretos - SP</p>
            </div>
            <div class="flex gap-4 items-center">
                <div class="flex gap-2">
                    <input v-model="searchId" type="text" placeholder="Protocolo..." class="px-4 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-500">
                    <button @click="checkProtocol" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold">Buscar</button>
                </div>
                <button @click="handleLogout" class="text-slate-400 hover:text-red-500 flex items-center gap-1 font-bold text-xs uppercase">
                    Sair <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-xs font-bold uppercase">Total de Relatos</p>
                <h2 class="text-3xl font-black text-slate-800">{{ reports.length }}</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-xs font-bold uppercase text-emerald-600">Resolvidos</p>
                <h2 class="text-3xl font-black text-emerald-600">{{ solvedCount }}</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-xs font-bold uppercase text-blue-600">Em Aberto</p>
                <h2 class="text-3xl font-black text-blue-600">{{ openCount }}</h2>
            </div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-4">Categorias</h3>
                    <div class="space-y-2">
                        <button @click="filterCategory = 'all'" :class="filterCategory === 'all' ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'text-slate-600 border-transparent'" class="w-full text-left px-3 py-2 rounded-lg border text-sm font-medium transition">Todas</button>
                        <button v-for="cat in uniqueCategories" @click="filterCategory = cat" :class="filterCategory === cat ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'text-slate-600 border-transparent'" class="w-full text-left px-3 py-2 rounded-lg border text-sm font-medium transition">{{ cat }}</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-200">
                    <div id="map"></div>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
    const { createApp } = Vue;
    
    // ATENÇÃO: Substitua pelos seus dados reais do Supabase
    const supabaseUrl = 'https://ngjuarfnlepwmvzmkukw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nanVhcmZubGVwd212em1rdWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjI4NzcsImV4cCI6MjA4NDY5ODg3N30.w67LAEv_D6dn-N2IIGEBKbniwWNdDe7IuBEWptsEqC0';
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    createApp({
        data() {
            return {
                isLoggedIn: false,
                loading: false,
                loginForm: { email: '', pass: '' },
                map: null,
                reports: [],
                markers: [],
                filterCategory: 'all',
                searchId: '',
            }
        },
        computed: {
            uniqueCategories() {
                const cats = this.reports.map(r => r.categoryLabel).filter(Boolean);
                return [...new Set(cats)];
            },
            filteredReports() {
                if (this.filterCategory === 'all') return this.reports;
                return this.reports.filter(r => r.categoryLabel === this.filterCategory);
            },
            solvedCount() { return this.reports.filter(r => r.status === 'resolvido').length },
            openCount() { return this.reports.filter(r => r.status !== 'resolvido').length }
        },
        watch: {
            filterCategory() { this.renderMarkers(); }
        },
        async mounted() {
            // Verifica se existe sessão ativa ao carregar a página
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) {
                this.isLoggedIn = true;
                this.$nextTick(() => { this.initApp(); });
            }
        },
        methods: {
            async handleLogin() {
                if (!this.loginForm.email || !this.loginForm.pass) {
                    alert("Preencha e-mail e senha.");
                    return;
                }

                this.loading = true;
                const { data, error } = await _supabase.auth.signInWithPassword({
                    email: this.loginForm.email,
                    password: this.loginForm.pass
                });

                if (error) {
                    alert("Erro no login: " + error.message);
                    this.loading = false;
                } else {
                    this.isLoggedIn = true;
                    this.loading = false;
                    this.$nextTick(() => { this.initApp(); });
                }
            },
            async handleLogout() {
                await _supabase.auth.signOut();
                this.isLoggedIn = false;
                location.reload(); // Limpa o estado do mapa
            },
            initApp() {
                this.initMap();
                this.loadReports();
                this.setupRealtime();
            },
            initMap() {
                if (this.map) return;
                this.map = L.map('map').setView([-20.557, -48.567], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
            },
            async loadReports() {
                const { data, error } = await _supabase.from('public_map_reports').select('*');
                if (!error) {
                    this.reports = data;
                    this.renderMarkers();
                }
            },
            renderMarkers() {
                if(!this.map) return;
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                this.filteredReports.forEach(r => {
                    const marker = L.marker([r.lat, r.lon])
                        .addTo(this.map)
                        .bindPopup(`
                            <div style="min-width:160px">
                                <b style="font-size:14px">${r.categoryLabel}</b><br>
                                <div style="margin:5px 0">
                                    <span class="status-badge status-${(r.status || 'aberto').toLowerCase()}">${r.status || 'Aberto'}</span>
                                </div>
                                <small style="color:#666">${new Date(r.createdAt).toLocaleString('pt-BR')}</small>
                            </div>
                        `);
                    this.markers.push(marker);
                });
            },
            setupRealtime() {
                _supabase.channel('map-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'public_map_reports' }, () => {
                        this.loadReports();
                    }).subscribe();
            },
            async checkProtocol() {
                if(!this.searchId) return;
                // Busca na tabela principal onde o usuário salvou pelo app
                const { data, error } = await _supabase.from('reports').select('*').eq('id', this.searchId).single();
                if(data) {
                    alert(`Protocolo Localizado!\nStatus: ${data.status}\nLocal: ${data.addressText || 'Barretos'}`);
                } else {
                    alert("Protocolo não encontrado no banco de dados.");
                }
            }
        }
    }).mount('#app')
</script>
</body>
</html>
