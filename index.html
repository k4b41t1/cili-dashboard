<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CiLi - Dashboard Privado</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --c-bg: #f8fafc;
      --c-card: #ffffff;
      --c-border: #e2e8f0;
      --c-text: #0f172a;
      --c-muted: #64748b;
      --c-brand: #0f766e;
      --c-accent: #22c55e;
      --c-danger: #dc2626;
    }
    body { background: radial-gradient(circle at 20% 0%, #dcfce7 0%, var(--c-bg) 45%); color: var(--c-text); }
    .card { background: var(--c-card); border: 1px solid var(--c-border); border-radius: 16px; }
    .btn-primary { background: linear-gradient(135deg, #0f766e, #0891b2); color: #fff; }
    .btn-secondary { background: #0f172a; color: #fff; }
    .btn-danger { background: var(--c-danger); color: #fff; }
    .status-dot { width: 8px; height: 8px; border-radius: 999px; display: inline-block; }
    #hotspotMap { height: 420px; border-radius: 14px; }
    .table-wrap { max-height: 360px; overflow: auto; }
    .hidden { display: none; }
    .alert-error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; border-radius: 12px; padding: 10px 12px; }
    .loading-overlay { background: rgba(15, 23, 42, 0.38); backdrop-filter: blur(2px); }
    .spinner { width: 38px; height: 38px; border: 4px solid rgba(255,255,255,0.35); border-top-color: #fff; border-radius: 999px; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .protocol-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; }
    .protocol-grid { display: grid; grid-template-columns: 320px 1fr; gap: 14px; }
    .protocol-image { width: 320px; height: 240px; object-fit: cover; border-radius: 10px; background: #e2e8f0; cursor: zoom-in; }
    .protocol-image-hint { margin-top: 6px; font-size: 10px; color: #64748b; font-weight: 600; }
    .protocol-field { margin: 0; font-size: 12px; color: #334155; }
    .protocol-field b { color: #0f172a; }
    .protocol-status { display: inline-block; border-radius: 999px; padding: 3px 8px; font-size: 11px; font-weight: 700; }
    .protocol-status.pending { background: #fef3c7; color: #92400e; }
    .protocol-status.resolved { background: #dcfce7; color: #166534; }
    .protocol-modal { position: fixed; inset: 0; z-index: 60; background: rgba(2, 6, 23, 0.75); display: none; align-items: center; justify-content: center; padding: 20px; }
    .protocol-modal.show { display: flex; }
    .protocol-modal-content { position: relative; max-width: min(96vw, 1400px); max-height: 92vh; display: flex; flex-direction: column; gap: 10px; }
    .protocol-modal-stage { width: min(94vw, 1360px); height: min(82vh, 920px); border-radius: 12px; border: 1px solid rgba(255,255,255,.25); overflow: hidden; touch-action: none; display: flex; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.25); }
    .protocol-modal-image { max-width: 100%; max-height: 100%; border-radius: 10px; transform-origin: center center; user-select: none; -webkit-user-drag: none; cursor: zoom-in; }
    .protocol-modal-image.zoomed { cursor: grab; }
    .protocol-modal-image.dragging { cursor: grabbing; }
    .protocol-modal-toolbar { display: flex; justify-content: center; gap: 8px; }
    .protocol-modal-tool { min-width: 38px; height: 34px; border-radius: 999px; border: 0; background: #ffffff; color: #0f172a; font-weight: 800; cursor: pointer; }
    .protocol-modal-close { position: absolute; top: -12px; right: -12px; width: 34px; height: 34px; border-radius: 999px; border: 0; background: #ffffff; color: #0f172a; font-size: 22px; line-height: 1; cursor: pointer; }
    @media (max-width: 768px) {
      .protocol-grid { grid-template-columns: 1fr; }
      .protocol-image { width: 100%; height: 200px; }
    }
  </style>
</head>
<body class="min-h-screen font-sans">
  <div class="max-w-7xl mx-auto p-4 sm:p-6 space-y-5">
    <header class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-black tracking-tight">CiLi <span class="text-emerald-700">Dashboard Privado</span></h1>
        <p class="text-xs sm:text-sm text-slate-600 font-semibold">Gestao de dados para clientes pagantes (acesso controlado)</p>
      </div>
      <div id="sessionBadge" class="hidden card px-4 py-3 text-sm"></div>
    </header>

    <section class="card p-4 sm:p-5 space-y-4">
      <h2 class="font-extrabold text-slate-800 text-sm uppercase tracking-wide">Acesso</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="text-sm">
          <span class="font-semibold text-slate-700">Supabase URL</span>
          <input id="sbUrl" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm" placeholder="https://seu-projeto.supabase.co">
        </label>
        <label class="text-sm">
          <span class="font-semibold text-slate-700">Supabase ANON KEY</span>
          <input id="sbAnon" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm" placeholder="eyJ...">
        </label>
        <label class="text-sm">
          <span class="font-semibold text-slate-700">E-mail</span>
          <input id="email" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm" placeholder="admin@prefeitura.gov.br">
        </label>
        <label class="text-sm">
          <span class="font-semibold text-slate-700">Senha</span>
          <input id="password" type="password" class="mt-1 w-full border rounded-lg px-3 py-2 text-sm" placeholder="********">
        </label>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="saveConfigBtn" class="btn-secondary rounded-lg px-4 py-2 text-sm font-bold">Salvar Config</button>
        <button id="loginBtn" class="btn-primary rounded-lg px-4 py-2 text-sm font-bold">Entrar</button>
        <button id="logoutBtn" class="btn-danger rounded-lg px-4 py-2 text-sm font-bold">Sair</button>
      </div>
      <p id="authMsg" class="text-xs text-slate-600"></p>
    </section>

    <section id="dashboardSection" class="hidden space-y-5">
      <div id="globalError" class="hidden alert-error text-sm font-semibold"></div>

      <div class="card p-4 sm:p-5 space-y-3">
        <h2 class="font-extrabold text-slate-800 text-sm uppercase tracking-wide">Filtros</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-8 gap-2">
          <label class="text-xs font-semibold text-slate-700">De
            <input id="fromDate" type="date" class="mt-1 w-full border rounded-md px-2 py-2 text-sm">
          </label>
          <label class="text-xs font-semibold text-slate-700">Ate
            <input id="toDate" type="date" class="mt-1 w-full border rounded-md px-2 py-2 text-sm">
          </label>
          <label class="text-xs font-semibold text-slate-700">Cidade
            <input id="cityFilter" class="mt-1 w-full border rounded-md px-2 py-2 text-sm" placeholder="Barretos">
          </label>
          <label class="text-xs font-semibold text-slate-700">Bairro
            <input id="neighborhoodFilter" class="mt-1 w-full border rounded-md px-2 py-2 text-sm" placeholder="Centro">
          </label>
          <label class="text-xs font-semibold text-slate-700">Categoria ID
            <input id="categoryFilter" class="mt-1 w-full border rounded-md px-2 py-2 text-sm" placeholder="limpeza_urbana">
          </label>
          <label class="text-xs font-semibold text-slate-700">Status
            <input id="statusFilter" class="mt-1 w-full border rounded-md px-2 py-2 text-sm" placeholder="resolvido">
          </label>
          <label class="text-xs font-semibold text-slate-700">Serie
            <select id="bucketFilter" class="mt-1 w-full border rounded-md px-2 py-2 text-sm">
              <option value="day">Dia</option>
              <option value="week">Semana</option>
              <option value="month">Mes</option>
            </select>
          </label>
          <div class="flex items-end gap-2">
            <button id="refreshBtn" class="btn-primary rounded-md px-3 py-2 text-sm font-bold w-full">Atualizar</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3">
        <article class="card p-4"><p class="text-xs text-slate-500">Relatos</p><p id="kpiTotal" class="text-2xl font-black">0</p></article>
        <article class="card p-4"><p class="text-xs text-slate-500">Resolvidos</p><p id="kpiResolved" class="text-2xl font-black text-emerald-700">0</p></article>
        <article class="card p-4"><p class="text-xs text-slate-500">Pendentes</p><p id="kpiPending" class="text-2xl font-black text-amber-600">0</p></article>
        <article class="card p-4"><p class="text-xs text-slate-500">Taxa Resolucao</p><p id="kpiRate" class="text-2xl font-black text-cyan-700">0%</p></article>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
        <section class="card p-4 xl:col-span-2">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-extrabold text-slate-800">Serie Temporal</h3>
            <span class="text-xs text-slate-500">Relatos x Resolucao</span>
          </div>
          <canvas id="seriesChart" height="110"></canvas>
        </section>
        <section class="card p-4">
          <h3 class="font-extrabold text-slate-800 mb-3">SLA</h3>
          <div class="space-y-1 text-sm">
            <p>Total: <b id="slaTotal">0</b></p>
            <p>Resolvidos em 24h: <b id="sla24">0</b></p>
            <p>Resolvidos em 72h: <b id="sla72">0</b></p>
            <p>Resolvidos em 7d: <b id="sla7d">0</b></p>
            <p>Apos 7d: <b id="slaOver7d">0</b></p>
            <p>Em aberto: <b id="slaUnresolved">0</b></p>
            <p>% ate 72h: <b id="slaPct72">0%</b></p>
            <p>% ate 7d: <b id="slaPct7d">0%</b></p>
          </div>
          <hr class="my-3 border-slate-200">
          <h3 class="font-extrabold text-slate-800 mb-2">Satisfacao (1-5)</h3>
          <div class="space-y-1 text-sm">
            <p>Respostas: <b id="satTotal">0</b></p>
            <p>Media geral: <b id="satAvg">0.00</b></p>
            <p>Tempo: <b id="satSpeed">0.00</b></p>
            <p>Qualidade: <b id="satQuality">0.00</b></p>
            <p>Comunicacao: <b id="satComm">0.00</b></p>
            <p>% positivo (>=4): <b id="satPositive">0%</b></p>
            <p id="satDist" class="text-xs text-slate-600 font-semibold">1★:0 2★:0 3★:0 4★:0 5★:0</p>
          </div>
        </section>
      </div>

    <section class="grid grid-cols-1 xl:grid-cols-2 gap-4">
      <article class="card p-4 xl:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-extrabold text-slate-800">Evolucao da Satisfacao</h3>
          <span class="text-xs text-slate-500">Media geral (1-5) e total de respostas</span>
        </div>
        <canvas id="satisfactionChart" height="95"></canvas>
      </article>

      <article class="card p-4">
        <h3 class="font-extrabold text-slate-800 mb-2">Breakdown por Categoria</h3>
        <div class="table-wrap">
            <table class="w-full text-sm">
              <thead class="sticky top-0 bg-white">
                <tr class="text-left text-slate-500">
                  <th class="py-2">Dimensao</th>
                  <th class="py-2">Total</th>
                  <th class="py-2">Taxa</th>
                  <th class="py-2">Apoios</th>
                  <th class="py-2">Comentarios</th>
                </tr>
              </thead>
              <tbody id="breakdownBody"></tbody>
            </table>
          </div>
        </article>

        <article class="card p-4">
          <h3 class="font-extrabold text-slate-800 mb-2">Hotspots (Mapa)</h3>
          <div id="hotspotMap"></div>
        </article>
      </section>

      <section class="card p-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-2">
          <h3 class="font-extrabold text-slate-800">Relatos Filtrados</h3>
          <div class="flex items-center gap-2">
            <label class="text-xs font-semibold text-slate-700">Por pagina
              <select id="pageSizeSelect" class="border rounded-md px-2 py-1 text-xs">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
              </select>
            </label>
            <button id="exportCsvBtn" class="btn-secondary rounded-md px-3 py-2 text-xs font-bold">Exportar CSV</button>
            <button id="exportPdfBtn" class="btn-primary rounded-md px-3 py-2 text-xs font-bold">Exportar PDF</button>
          </div>
        </div>
        <div class="table-wrap">
          <table class="w-full text-sm">
            <thead class="sticky top-0 bg-white">
              <tr class="text-left text-slate-500">
                <th class="py-2">ID</th>
                <th class="py-2">Data</th>
                <th class="py-2">Cidade</th>
                <th class="py-2">Categoria</th>
                <th class="py-2">Status</th>
                <th class="py-2">Apoios</th>
                <th class="py-2">Comentarios</th>
              </tr>
            </thead>
            <tbody id="reportsBody"></tbody>
          </table>
        </div>
        <div class="flex items-center justify-between mt-3">
          <p id="pageInfo" class="text-xs text-slate-600 font-semibold">Pagina 1</p>
          <div class="flex gap-2">
            <button id="prevPageBtn" class="rounded-md border px-3 py-1 text-xs font-bold">Anterior</button>
            <button id="nextPageBtn" class="rounded-md border px-3 py-1 text-xs font-bold">Proxima</button>
          </div>
        </div>
      </section>

      <section class="card p-4 space-y-2">
        <h3 class="font-extrabold text-slate-800">Consulta de Protocolo</h3>
        <div class="flex gap-2">
          <input id="protocolInput" class="w-full border rounded-md px-3 py-2 text-sm" placeholder="UUID do relato">
          <button id="protocolBtn" class="btn-primary rounded-md px-3 py-2 text-sm font-bold">Consultar</button>
        </div>
        <div id="protocolOutput" class="bg-slate-900 text-green-300 rounded-md p-3 text-xs overflow-auto">Sem consulta.</div>
      </section>
    </section>
  </div>

  <div id="loadingOverlay" class="hidden loading-overlay fixed inset-0 z-50 items-center justify-center">
    <div class="flex flex-col items-center gap-3">
      <div class="spinner"></div>
      <p class="text-white font-bold text-sm tracking-wide">Carregando dados...</p>
    </div>
  </div>
  <div id="protocolImageModal" class="protocol-modal" aria-hidden="true">
    <div id="protocolImageModalContent" class="protocol-modal-content">
      <button id="protocolImageModalClose" class="protocol-modal-close" type="button" aria-label="Fechar imagem">&times;</button>
      <div id="protocolImageModalStage" class="protocol-modal-stage">
        <img id="protocolImageModalImg" class="protocol-modal-image" src="" alt="Imagem ampliada do protocolo">
      </div>
      <div class="protocol-modal-toolbar" aria-label="Ferramentas de zoom da imagem">
        <button id="protocolImageZoomOut" class="protocol-modal-tool" type="button" aria-label="Diminuir zoom">-</button>
        <button id="protocolImageZoomReset" class="protocol-modal-tool" type="button" aria-label="Resetar zoom">100%</button>
        <button id="protocolImageZoomIn" class="protocol-modal-tool" type="button" aria-label="Aumentar zoom">+</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script>
    const LS_CONFIG_KEY = "cili_dashboard_private_config_v1";
    const state = {
      sb: null,
      session: null,
      charts: { series: null, satisfaction: null },
      map: null,
      hotspotLayer: null,
      reports: [],
      dashboardData: {
        kpi: [],
        series: [],
        breakdown: [],
        sla: [],
        hotspots: [],
        satisfactionSummary: [],
        satisfactionDistribution: [],
        satisfactionSeries: []
      },
      loading: false,
      reportsPage: 0,
      reportsPageSize: 50,
      hasNextPage: false
    };

    const el = (id) => document.getElementById(id);
    const setText = (id, value) => { el(id).textContent = String(value ?? ""); };

    function nowIsoDate() {
      return new Date().toISOString().slice(0, 10);
    }

    function thirtyDaysAgoIsoDate() {
      const d = new Date();
      d.setDate(d.getDate() - 30);
      return d.toISOString().slice(0, 10);
    }

    function loadSavedConfig() {
      try {
        const raw = localStorage.getItem(LS_CONFIG_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (_e) {
        return null;
      }
    }

    function saveConfig() {
      const cfg = {
        url: el("sbUrl").value.trim(),
        anon: el("sbAnon").value.trim(),
        email: el("email").value.trim()
      };
      localStorage.setItem(LS_CONFIG_KEY, JSON.stringify(cfg));
      setAuthMessage("Configuracao salva no navegador.");
      return cfg;
    }

    function setAuthMessage(msg, isError = false) {
      const target = el("authMsg");
      target.textContent = msg;
      target.className = isError ? "text-xs text-red-700 font-semibold" : "text-xs text-slate-600";
    }

    function setGlobalError(msg) {
      const box = el("globalError");
      if (!msg) {
        box.classList.add("hidden");
        box.textContent = "";
        return;
      }
      box.textContent = msg;
      box.classList.remove("hidden");
    }

    function setLoading(isLoading) {
      state.loading = isLoading;
      const overlay = el("loadingOverlay");
      if (isLoading) {
        overlay.classList.remove("hidden");
        overlay.classList.add("flex");
      } else {
        overlay.classList.add("hidden");
        overlay.classList.remove("flex");
      }

      [
        "refreshBtn", "protocolBtn", "exportCsvBtn", "exportPdfBtn", "prevPageBtn",
        "nextPageBtn", "pageSizeSelect"
      ].forEach((id) => {
        const node = el(id);
        if (node) node.disabled = isLoading;
      });
    }

    function friendlyError(err) {
      const msg = (err?.message || String(err || "")).toLowerCase();
      if (msg.includes("dashboard_access_denied")) return "Acesso negado: usuario sem permissao de dashboard ou assinatura inativa.";
      if (msg.includes("authentication_required")) return "Sessao invalida. Faca login novamente.";
      if (msg.includes("invalid_bucket")) return "Filtro de serie temporal invalido.";
      if (msg.includes("invalid_dimension")) return "Dimensao de analise invalida.";
      if (msg.includes("failed to fetch") || msg.includes("network")) return "Falha de rede ao consultar o Supabase.";
      return err?.message || String(err);
    }

    function toIsoStart(dateStr) {
      if (!dateStr) return null;
      return dateStr + "T00:00:00Z";
    }

    function toIsoEnd(dateStr) {
      if (!dateStr) return null;
      return dateStr + "T23:59:59Z";
    }

    function normalizeFilters() {
      const city = el("cityFilter").value.trim() || null;
      const neighborhood = el("neighborhoodFilter").value.trim() || null;
      const category = el("categoryFilter").value.trim() || null;
      const status = el("statusFilter").value.trim() || null;
      return {
        p_from: toIsoStart(el("fromDate").value),
        p_to: toIsoEnd(el("toDate").value),
        p_city: city,
        p_neighborhood: neighborhood,
        p_category_id: category,
        p_status: status
      };
    }

    function ensureMap() {
      if (state.map) return;
      state.map = L.map("hotspotMap").setView([-20.5594, -48.5677], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(state.map);
      state.hotspotLayer = L.layerGroup().addTo(state.map);
    }

    async function rpc(name, args) {
      const { data, error } = await state.sb.rpc(name, args);
      if (error) throw error;
      return data || [];
    }

    async function rpcKpis(args) {
      try {
        return await rpc("dashboard_kpis", args);
      } catch (e) {
        const msg = (e?.message || String(e || "")).toLowerCase();
        if (!msg.includes("could not find the function public.dashboard_kpis")) throw e;
        return await rpc("dashboard_kpis_compat", {
          p_category_id: args?.p_category_id ?? null,
          p_city: args?.p_city ?? null,
          p_from: args?.p_from ?? null,
          p_to: args?.p_to ?? null
        });
      }
    }

    async function rpcOptional(name, args) {
      try {
        return await rpc(name, args);
      } catch (e) {
        const msg = String(e?.message || "").toLowerCase();
        if (msg.includes(`could not find the function public.${name}`)) return [];
        throw e;
      }
    }

    function formatDate(ts) {
      if (!ts) return "-";
      const dt = new Date(ts);
      if (isNaN(dt.getTime())) return "-";
      return dt.toLocaleDateString("pt-BR");
    }

    function formatPct(v) {
      const n = Number(v || 0);
      return n.toFixed(2) + "%";
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
    }

    function statusLabel(rawStatus) {
      const status = String(rawStatus || "").toLowerCase();
      if (status === "resolvido") return "Resolvido";
      return "Pendente";
    }

    const protocolImageZoom = {
      scale: 1,
      minScale: 1,
      maxScale: 4,
      x: 0,
      y: 0,
      dragging: false,
      lastX: 0,
      lastY: 0,
      pinchDistance: null,
      pinchStartScale: 1
    };

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function clampProtocolImagePan() {
      const img = el("protocolImageModalImg");
      const stage = el("protocolImageModalStage");
      const stageWidth = stage.clientWidth || 0;
      const stageHeight = stage.clientHeight || 0;
      const maxX = Math.max(0, ((img.clientWidth * protocolImageZoom.scale) - stageWidth) / 2);
      const maxY = Math.max(0, ((img.clientHeight * protocolImageZoom.scale) - stageHeight) / 2);
      protocolImageZoom.x = clamp(protocolImageZoom.x, -maxX, maxX);
      protocolImageZoom.y = clamp(protocolImageZoom.y, -maxY, maxY);
    }

    function applyProtocolImageTransform() {
      const img = el("protocolImageModalImg");
      clampProtocolImagePan();
      img.style.transform = `translate(${protocolImageZoom.x}px, ${protocolImageZoom.y}px) scale(${protocolImageZoom.scale})`;
      img.classList.toggle("zoomed", protocolImageZoom.scale > 1);
    }

    function resetProtocolImageZoom() {
      protocolImageZoom.scale = 1;
      protocolImageZoom.x = 0;
      protocolImageZoom.y = 0;
      protocolImageZoom.dragging = false;
      protocolImageZoom.pinchDistance = null;
      applyProtocolImageTransform();
    }

    function setProtocolImageZoom(nextScale) {
      const oldScale = protocolImageZoom.scale;
      const scale = clamp(nextScale, protocolImageZoom.minScale, protocolImageZoom.maxScale);
      if (Math.abs(scale - oldScale) < 0.001) return;
      const ratio = scale / oldScale;
      protocolImageZoom.scale = scale;
      protocolImageZoom.x *= ratio;
      protocolImageZoom.y *= ratio;
      if (scale <= 1) {
        protocolImageZoom.x = 0;
        protocolImageZoom.y = 0;
      }
      applyProtocolImageTransform();
    }

    function protocolTouchDistance(touches) {
      if (!touches || touches.length < 2) return 0;
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.hypot(dx, dy);
    }

    function openProtocolImageModal(imageUrl) {
      if (!imageUrl) return;
      const modal = el("protocolImageModal");
      const img = el("protocolImageModalImg");
      resetProtocolImageZoom();
      img.src = imageUrl;
      modal.classList.add("show");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeProtocolImageModal() {
      const modal = el("protocolImageModal");
      const img = el("protocolImageModalImg");
      modal.classList.remove("show");
      modal.setAttribute("aria-hidden", "true");
      resetProtocolImageZoom();
      img.classList.remove("dragging");
      img.src = "";
    }

    function renderProtocolDetails(record) {
      if (!record) return "Sem consulta.";

      const imageUrl = record.watermarked_uri || record.image_uri || "";
      const hasImage = /^https?:\/\//i.test(imageUrl);
      const status = String(record.status || "").toLowerCase();
      const statusClass = status === "resolvido" ? "resolved" : "pending";

      return `
        <div class="protocol-card">
          <div class="protocol-grid">
            <div>
              ${
                hasImage
                  ? `<img class="protocol-image" src="${escapeHtml(imageUrl)}" data-full-src="${escapeHtml(imageUrl)}" alt="Imagem do protocolo"><p class="protocol-image-hint">Clique para ampliar. No modal: use +/-, roda do mouse ou pinça.</p>`
                  : `<div class="protocol-image"></div>`
              }
            </div>
            <div>
              <p class="protocol-field"><b>Protocolo:</b> ${escapeHtml(record.id)}</p>
              <p class="protocol-field"><b>Categoria:</b> ${escapeHtml(record.category_label || "-")}</p>
              <p class="protocol-field"><b>Status:</b> <span class="protocol-status ${statusClass}">${statusLabel(record.status)}</span></p>
              <p class="protocol-field"><b>Data:</b> ${escapeHtml(formatDate(record.created_at))}</p>
              <p class="protocol-field"><b>Cidade:</b> ${escapeHtml(record.city || "-")}</p>
              <p class="protocol-field"><b>Local:</b> ${escapeHtml(record.address_hint || record.address_text || "-")}</p>
              <p class="protocol-field"><b>Apoios:</b> ${escapeHtml(record.supports_count || 0)} | <b>Comentários:</b> ${escapeHtml(record.comments_count || 0)}</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderKpis(kpi) {
      const row = Array.isArray(kpi) ? kpi[0] : null;
      setText("kpiTotal", row?.total_reports || 0);
      setText("kpiResolved", row?.resolved_reports || 0);
      setText("kpiPending", row?.pending_reports || 0);
      setText("kpiRate", formatPct(row?.resolution_rate || 0));
    }

    function renderSla(sla) {
      const row = Array.isArray(sla) ? sla[0] : null;
      setText("slaTotal", row?.total_reports || 0);
      setText("sla24", row?.resolved_24h || 0);
      setText("sla72", row?.resolved_72h || 0);
      setText("sla7d", row?.resolved_7d || 0);
      setText("slaOver7d", row?.resolved_over_7d || 0);
      setText("slaUnresolved", row?.unresolved_total || 0);
      setText("slaPct72", formatPct(row?.pct_resolved_72h || 0));
      setText("slaPct7d", formatPct(row?.pct_resolved_7d || 0));
    }

    function renderSatisfaction(summary, distribution) {
      const row = Array.isArray(summary) ? summary[0] : null;
      const fmt = (value) => Number(value || 0).toFixed(2);
      setText("satTotal", row?.total_feedback || 0);
      setText("satAvg", fmt(row?.avg_overall));
      setText("satSpeed", fmt(row?.avg_speed));
      setText("satQuality", fmt(row?.avg_quality));
      setText("satComm", fmt(row?.avg_communication));
      setText("satPositive", formatPct(row?.pct_positive || 0));

      const distMap = new Map();
      (distribution || []).forEach((item) => {
        distMap.set(Number(item.score), Number(item.total || 0));
      });
      const text = [1, 2, 3, 4, 5]
        .map((score) => `${score}★:${distMap.get(score) || 0}`)
        .join(" ");
      setText("satDist", text);
    }

    function renderSatisfactionSeries(rows) {
      const data = Array.isArray(rows) ? rows : [];
      const labels = data.map((i) => formatDate(i.period_start));
      const avgOverall = data.map((i) => Number(i.avg_overall || 0));
      const totals = data.map((i) => Number(i.total_feedback || 0));

      const ctx = el("satisfactionChart").getContext("2d");
      if (state.charts.satisfaction) state.charts.satisfaction.destroy();
      state.charts.satisfaction = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              type: "line",
              label: "Media geral (1-5)",
              data: avgOverall,
              borderColor: "#7C3AED",
              backgroundColor: "rgba(124,58,237,.18)",
              yAxisID: "yAvg",
              fill: true,
              tension: 0.25
            },
            {
              type: "bar",
              label: "Respostas",
              data: totals,
              backgroundColor: "rgba(14,165,233,.32)",
              borderColor: "#0284C7",
              borderWidth: 1,
              yAxisID: "yCount"
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: {
            yAvg: { position: "left", min: 0, max: 5, ticks: { stepSize: 1 } },
            yCount: { position: "right", beginAtZero: true, grid: { drawOnChartArea: false }, ticks: { precision: 0 } }
          }
        }
      });
    }

    function renderSeries(seriesData) {
      const labels = seriesData.map((i) => formatDate(i.period_start));
      const total = seriesData.map((i) => Number(i.total_reports || 0));
      const resolved = seriesData.map((i) => Number(i.resolved_reports || 0));
      const pending = seriesData.map((i) => Number(i.pending_reports || 0));

      const ctx = el("seriesChart").getContext("2d");
      if (state.charts.series) state.charts.series.destroy();
      state.charts.series = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Total", data: total, borderColor: "#0ea5e9", backgroundColor: "rgba(14,165,233,.18)", fill: true, tension: .25 },
            { label: "Resolvidos", data: resolved, borderColor: "#16a34a", backgroundColor: "rgba(22,163,74,.10)", fill: false, tension: .25 },
            { label: "Pendentes", data: pending, borderColor: "#f59e0b", backgroundColor: "rgba(245,158,11,.10)", fill: false, tension: .25 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });
    }

    function renderBreakdown(rows) {
      const tbody = el("breakdownBody");
      tbody.innerHTML = "";
      if (!rows.length) {
        tbody.innerHTML = "<tr><td colspan='5' class='py-3 text-slate-500'>Sem dados no filtro atual.</td></tr>";
        return;
      }
      rows.forEach((r) => {
        const tr = document.createElement("tr");
        tr.className = "border-t";
        tr.innerHTML = `
          <td class="py-2 font-semibold">${r.dimension || "Nao informado"}</td>
          <td class="py-2">${r.total_reports || 0}</td>
          <td class="py-2">${formatPct(r.resolution_rate || 0)}</td>
          <td class="py-2">${r.total_supports || 0}</td>
          <td class="py-2">${r.total_comments || 0}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderReports(rows) {
      state.reports = rows || [];
      const tbody = el("reportsBody");
      tbody.innerHTML = "";
      if (!rows.length) {
        tbody.innerHTML = "<tr><td colspan='7' class='py-3 text-slate-500'>Sem registros.</td></tr>";
        return;
      }
      rows.forEach((r) => {
        const tr = document.createElement("tr");
        tr.className = "border-t";
        tr.innerHTML = `
          <td class="py-2 font-mono text-xs">
            <button
              type="button"
              class="text-cyan-700 hover:text-cyan-900 hover:underline font-semibold text-left"
              data-report-id="${r.id || ""}"
              title="Consultar protocolo"
            >
              ${r.id || ""}
            </button>
          </td>
          <td class="py-2">${formatDate(r.created_at)}</td>
          <td class="py-2">${r.city || "-"}</td>
          <td class="py-2">${r.category_label || r.category_id || "-"}</td>
          <td class="py-2">${r.status || "-"}</td>
          <td class="py-2">${r.supports_count || 0}</td>
          <td class="py-2">${r.comments_count || 0}</td>
        `;
        tbody.appendChild(tr);
      });
      updatePaginationUI();
    }

    function renderHotspots(rows) {
      ensureMap();
      state.hotspotLayer.clearLayers();
      if (!rows.length) return;

      const latlngs = [];
      rows.forEach((h) => {
        const lat = Number(h.lat_bin);
        const lon = Number(h.lon_bin);
        if (!isFinite(lat) || !isFinite(lon)) return;
        latlngs.push([lat, lon]);
        const intensity = Math.max(0.15, Math.min(0.85, Number(h.total_reports || 1) / 30));
        const radius = 250 + (Number(h.total_reports || 1) * 20);
        L.circle([lat, lon], {
          radius,
          color: "#dc2626",
          weight: 1,
          fillColor: "#ef4444",
          fillOpacity: intensity
        }).bindPopup(`
          <b>Hotspot</b><br>
          Total: ${h.total_reports || 0}<br>
          Pendentes: ${h.pending_reports || 0}<br>
          Resolvidos: ${h.resolved_reports || 0}
        `).addTo(state.hotspotLayer);
      });
      if (latlngs.length) state.map.fitBounds(latlngs, { padding: [20, 20] });
    }

    function toCsvValue(v) {
      const s = String(v ?? "");
      if (s.includes(",") || s.includes("\"") || s.includes("\n")) {
        return "\"" + s.replaceAll("\"", "\"\"") + "\"";
      }
      return s;
    }

    function exportReportsCsv() {
      const rows = state.reports || [];
      if (!rows.length) {
        alert("Nao ha dados para exportar.");
        return;
      }
      const columns = ["id", "created_at", "status", "city", "category_id", "category_label", "group_label", "supports_count", "comments_count"];
      const lines = [columns.join(",")];
      rows.forEach((r) => {
        lines.push(columns.map((c) => toCsvValue(r[c])).join(","));
      });
      const blob = new Blob(["\uFEFF" + lines.join("\n")], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cili-dashboard-relatos.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function activeFiltersSummary() {
      const fromDate = el("fromDate").value || "-";
      const toDate = el("toDate").value || "-";
      const city = el("cityFilter").value.trim() || "Todas";
      const neighborhood = el("neighborhoodFilter").value.trim() || "Todos";
      const category = el("categoryFilter").value.trim() || "Todas";
      const status = el("statusFilter").value.trim() || "Todos";
      return `Periodo: ${fromDate} a ${toDate} | Cidade: ${city} | Bairro: ${neighborhood} | Categoria: ${category} | Status: ${status}`;
    }

    function num(v) {
      const n = Number(v || 0);
      return Number.isFinite(n) ? n : 0;
    }

    function exportDashboardPdf() {
      const jsPDFCtor = window.jspdf?.jsPDF;
      if (!jsPDFCtor) {
        alert("Biblioteca de PDF indisponivel. Recarregue a pagina.");
        return;
      }

      const kpiRow = Array.isArray(state.dashboardData.kpi) ? state.dashboardData.kpi[0] : null;
      const slaRow = Array.isArray(state.dashboardData.sla) ? state.dashboardData.sla[0] : null;
      const satRow = Array.isArray(state.dashboardData.satisfactionSummary) ? state.dashboardData.satisfactionSummary[0] : null;
      const breakdownRows = Array.isArray(state.dashboardData.breakdown) ? state.dashboardData.breakdown.slice(0, 12) : [];
      const reportsRows = Array.isArray(state.reports) ? state.reports.slice(0, 100) : [];

      const doc = new jsPDFCtor({ orientation: "portrait", unit: "mm", format: "a4" });
      const pageWidth = doc.internal.pageSize.getWidth();
      const generatedAt = new Date().toLocaleString("pt-BR");

      doc.setFontSize(16);
      doc.text("CiLi - Relatorio de Indicadores", 14, 16);
      doc.setFontSize(9);
      doc.text(`Gerado em: ${generatedAt}`, 14, 22);
      doc.text(activeFiltersSummary(), 14, 27, { maxWidth: pageWidth - 28 });

      doc.setFontSize(11);
      doc.text("Resumo Executivo", 14, 36);
      doc.setFontSize(9);
      const summaryLines = [
        `Relatos totais: ${num(kpiRow?.total_reports)}`,
        `Resolvidos: ${num(kpiRow?.resolved_reports)} | Pendentes: ${num(kpiRow?.pending_reports)}`,
        `Taxa de resolucao: ${formatPct(kpiRow?.resolution_rate)}`,
        `SLA <=72h: ${formatPct(slaRow?.pct_resolved_72h)} | SLA <=7d: ${formatPct(slaRow?.pct_resolved_7d)}`,
        `Satisfacao media: ${Number(satRow?.avg_overall || 0).toFixed(2)} | % positivo (>=4): ${formatPct(satRow?.pct_positive || 0)}`
      ];
      doc.text(summaryLines, 14, 42);

      const indicatorNotes = [
        ["Indicador", "Formula resumida", "Disponibilidade atual"],
        ["IRM", "Resolvidos / Total * 100", "Disponivel (status + reports)"],
        ["TMA", "Media do tempo ate resolucao", "Disponivel (created_at/status_date)"],
        ["SLA 72h / 7d", "% dentro da janela", "Disponivel (dashboard_sla_snapshot)"],
        ["ISC (1-5)", "Media de satisfacao do cidadao", "Disponivel (report_resolution_feedback)"],
        ["Densidade de problemas", "Relatos por area/bairro", "Parcial (hotspots e cidade/bairro)"],
        ["Engajamento civico", "Apoios e comentarios por relato", "Disponivel (supports/comments)"]
      ];

      doc.autoTable({
        startY: 56,
        head: [indicatorNotes[0]],
        body: indicatorNotes.slice(1),
        styles: { fontSize: 8 },
        headStyles: { fillColor: [15, 118, 110] }
      });

      const breakdownBody = breakdownRows.map((r) => [
        String(r.dimension || "Nao informado"),
        String(num(r.total_reports)),
        formatPct(r.resolution_rate),
        String(num(r.total_supports)),
        String(num(r.total_comments))
      ]);

      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 6,
        head: [["Categoria", "Total", "Taxa", "Apoios", "Comentarios"]],
        body: breakdownBody.length ? breakdownBody : [["Sem dados", "0", "0.00%", "0", "0"]],
        styles: { fontSize: 8 },
        headStyles: { fillColor: [14, 165, 233] }
      });

      doc.addPage();
      doc.setFontSize(11);
      doc.text("Relatos Filtrados (amostra exportada)", 14, 14);

      const reportsBody = reportsRows.map((r) => [
        String(r.id || "").slice(0, 22),
        formatDate(r.created_at),
        String(r.city || "-"),
        String(r.category_label || r.category_id || "-"),
        String(r.status || "-"),
        String(num(r.supports_count)),
        String(num(r.comments_count))
      ]);

      doc.autoTable({
        startY: 18,
        head: [["ID", "Data", "Cidade", "Categoria", "Status", "Apoios", "Comentarios"]],
        body: reportsBody.length ? reportsBody : [["Sem registros", "-", "-", "-", "-", "-", "-"]],
        styles: { fontSize: 7 },
        headStyles: { fillColor: [15, 23, 42] }
      });

      const filenameDate = new Date().toISOString().slice(0, 10);
      doc.save(`cili-relatorio-publico-${filenameDate}.pdf`);
    }

    function updatePaginationUI() {
      const page = state.reportsPage + 1;
      setText("pageInfo", `Pagina ${page} • ${state.reportsPageSize} por pagina`);
      el("prevPageBtn").disabled = state.reportsPage === 0 || state.loading;
      el("nextPageBtn").disabled = !state.hasNextPage || state.loading;
    }

    async function refreshDashboard(keepPage = false) {
      if (!state.sb || !state.session) return;
      if (!keepPage) state.reportsPage = 0;
      const filters = normalizeFilters();
      const bucket = el("bucketFilter").value;
      setGlobalError("");
      setLoading(true);

      try {
        const [kpi, series, breakdown, sla, hotspots, reports, satisfactionSummary, satisfactionDistribution, satisfactionSeries] = await Promise.all([
          rpcKpis({
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_category_id: filters.p_category_id
          }),
          rpc("dashboard_timeseries", {
            p_bucket: bucket,
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_neighborhood: filters.p_neighborhood,
            p_category_id: filters.p_category_id,
            p_status: filters.p_status
          }),
          rpc("dashboard_breakdown", {
            p_dimension: "category",
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_neighborhood: filters.p_neighborhood,
            p_category_id: filters.p_category_id,
            p_status: filters.p_status,
            p_limit: 30
          }),
          rpc("dashboard_sla_snapshot", {
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_neighborhood: filters.p_neighborhood,
            p_category_id: filters.p_category_id
          }),
          rpc("dashboard_hotspots", {
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_neighborhood: filters.p_neighborhood,
            p_category_id: filters.p_category_id,
            p_precision: 3,
            p_limit: 200
          }),
          rpc("dashboard_reports_list", {
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_category_id: filters.p_category_id,
            p_status: filters.p_status,
            p_limit: state.reportsPageSize,
            p_offset: state.reportsPage * state.reportsPageSize
          }),
          rpcOptional("dashboard_satisfaction_summary", {
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_neighborhood: filters.p_neighborhood,
            p_category_id: filters.p_category_id,
            p_status: filters.p_status
          }),
          rpcOptional("dashboard_satisfaction_distribution", {
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_neighborhood: filters.p_neighborhood,
            p_category_id: filters.p_category_id,
            p_status: filters.p_status
          }),
          rpcOptional("dashboard_satisfaction_timeseries", {
            p_bucket: bucket,
            p_from: filters.p_from,
            p_to: filters.p_to,
            p_city: filters.p_city,
            p_neighborhood: filters.p_neighborhood,
            p_category_id: filters.p_category_id,
            p_status: filters.p_status
          })
        ]);

        renderKpis(kpi);
        renderSeries(series);
        renderBreakdown(breakdown);
        renderSla(sla);
        renderSatisfaction(satisfactionSummary, satisfactionDistribution);
        renderSatisfactionSeries(satisfactionSeries);
        renderHotspots(hotspots);
        state.dashboardData = {
          kpi,
          series,
          breakdown,
          sla,
          hotspots,
          satisfactionSummary,
          satisfactionDistribution,
          satisfactionSeries
        };
        state.hasNextPage = (reports?.length || 0) >= state.reportsPageSize;
        renderReports(reports);
      } catch (e) {
        setGlobalError("Falha ao carregar dashboard: " + friendlyError(e));
      } finally {
        setLoading(false);
        updatePaginationUI();
      }
    }

    async function protocolLookup(reportId = null) {
      const id = (reportId || el("protocolInput").value || "").trim();
      if (!id) return;
      el("protocolInput").value = id;
      setLoading(true);
      try {
        const data = await rpc("dashboard_protocol_lookup", { p_report_id: id });
        if (!data.length) {
          el("protocolOutput").textContent = "Protocolo nao encontrado no escopo permitido.";
          return;
        }
        el("protocolOutput").innerHTML = renderProtocolDetails(data[0]);
      } catch (e) {
        el("protocolOutput").textContent = "Erro: " + friendlyError(e);
      } finally {
        setLoading(false);
      }
    }

    function showDashboard(show) {
      el("dashboardSection").classList.toggle("hidden", !show);
      el("sessionBadge").classList.toggle("hidden", !show);
    }

    function setSessionBadge(user) {
      el("sessionBadge").innerHTML = `
        <div class="flex items-center gap-2">
          <span class="status-dot bg-emerald-500"></span>
          <span class="font-semibold">Sessao ativa:</span>
          <span>${user?.email || "usuario"}</span>
        </div>`;
    }

    function createClient() {
      const url = el("sbUrl").value.trim();
      const anon = el("sbAnon").value.trim();
      if (!url || !anon) {
        throw new Error("Informe Supabase URL e ANON KEY.");
      }
      state.sb = window.supabase.createClient(url, anon);
    }

    async function login() {
      try {
        createClient();
        const email = el("email").value.trim();
        const password = el("password").value;
        if (!email || !password) throw new Error("Informe e-mail e senha.");

        const { data, error } = await state.sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
        state.session = data.session;
        setSessionBadge(data.user);
        showDashboard(true);
        setAuthMessage("Autenticado com sucesso.");
        setGlobalError("");
        await refreshDashboard();
      } catch (e) {
        setAuthMessage("Falha no login: " + friendlyError(e), true);
      }
    }

    async function restoreSession() {
      const cfg = loadSavedConfig();
      if (!cfg?.url || !cfg?.anon) return;
      el("sbUrl").value = cfg.url;
      el("sbAnon").value = cfg.anon;
      if (cfg.email) el("email").value = cfg.email;

      try {
        createClient();
        const { data, error } = await state.sb.auth.getSession();
        if (error || !data.session) return;
        state.session = data.session;
        setSessionBadge(data.session.user);
        showDashboard(true);
        setAuthMessage("Sessao restaurada.");
        await refreshDashboard();
      } catch (_e) {
        showDashboard(false);
      }
    }

    async function logout() {
      if (!state.sb) return;
      await state.sb.auth.signOut();
      state.session = null;
      showDashboard(false);
      setAuthMessage("Sessao encerrada.");
      setGlobalError("");
    }

    function bindEvents() {
      el("saveConfigBtn").addEventListener("click", saveConfig);
      el("loginBtn").addEventListener("click", login);
      el("logoutBtn").addEventListener("click", logout);
      el("refreshBtn").addEventListener("click", refreshDashboard);
      el("protocolBtn").addEventListener("click", protocolLookup);
      el("exportCsvBtn").addEventListener("click", exportReportsCsv);
      el("exportPdfBtn").addEventListener("click", exportDashboardPdf);
      el("prevPageBtn").addEventListener("click", async () => {
        if (state.reportsPage === 0) return;
        state.reportsPage -= 1;
        await refreshDashboard(true);
      });
      el("nextPageBtn").addEventListener("click", async () => {
        if (!state.hasNextPage) return;
        state.reportsPage += 1;
        await refreshDashboard(true);
      });
      el("pageSizeSelect").addEventListener("change", async (e) => {
        const v = Number(e.target.value || 50);
        state.reportsPageSize = Number.isFinite(v) ? Math.max(10, Math.min(200, v)) : 50;
        state.reportsPage = 0;
        await refreshDashboard(true);
      });
      el("reportsBody").addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const trigger = target.closest("[data-report-id]");
        if (!(trigger instanceof HTMLElement)) return;
        const reportId = trigger.getAttribute("data-report-id");
        if (!reportId) return;
        await protocolLookup(reportId);
      });

      el("protocolOutput").addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const imageNode = target.closest("[data-full-src]");
        if (!(imageNode instanceof HTMLElement)) return;
        const imageUrl = imageNode.getAttribute("data-full-src");
        if (imageUrl) openProtocolImageModal(imageUrl);
      });

      el("protocolImageModalClose").addEventListener("click", closeProtocolImageModal);
      el("protocolImageZoomIn").addEventListener("click", () => setProtocolImageZoom(protocolImageZoom.scale + 0.25));
      el("protocolImageZoomOut").addEventListener("click", () => setProtocolImageZoom(protocolImageZoom.scale - 0.25));
      el("protocolImageZoomReset").addEventListener("click", resetProtocolImageZoom);
      el("protocolImageModalImg").addEventListener("dblclick", () => {
        if (protocolImageZoom.scale <= 1) setProtocolImageZoom(2);
        else resetProtocolImageZoom();
      });
      el("protocolImageModalImg").addEventListener("wheel", (event) => {
        event.preventDefault();
        const delta = event.deltaY < 0 ? 0.2 : -0.2;
        setProtocolImageZoom(protocolImageZoom.scale + delta);
      }, { passive: false });
      el("protocolImageModalImg").addEventListener("mousedown", (event) => {
        if (protocolImageZoom.scale <= 1) return;
        protocolImageZoom.dragging = true;
        protocolImageZoom.lastX = event.clientX;
        protocolImageZoom.lastY = event.clientY;
        el("protocolImageModalImg").classList.add("dragging");
      });
      document.addEventListener("mousemove", (event) => {
        if (!protocolImageZoom.dragging) return;
        const dx = event.clientX - protocolImageZoom.lastX;
        const dy = event.clientY - protocolImageZoom.lastY;
        protocolImageZoom.lastX = event.clientX;
        protocolImageZoom.lastY = event.clientY;
        protocolImageZoom.x += dx;
        protocolImageZoom.y += dy;
        applyProtocolImageTransform();
      });
      document.addEventListener("mouseup", () => {
        if (!protocolImageZoom.dragging) return;
        protocolImageZoom.dragging = false;
        el("protocolImageModalImg").classList.remove("dragging");
      });
      el("protocolImageModalStage").addEventListener("touchstart", (event) => {
        if (event.touches.length === 2) {
          protocolImageZoom.pinchDistance = protocolTouchDistance(event.touches);
          protocolImageZoom.pinchStartScale = protocolImageZoom.scale;
          protocolImageZoom.dragging = false;
          el("protocolImageModalImg").classList.remove("dragging");
          return;
        }
        if (event.touches.length === 1 && protocolImageZoom.scale > 1) {
          protocolImageZoom.dragging = true;
          protocolImageZoom.lastX = event.touches[0].clientX;
          protocolImageZoom.lastY = event.touches[0].clientY;
          el("protocolImageModalImg").classList.add("dragging");
        }
      }, { passive: true });
      el("protocolImageModalStage").addEventListener("touchmove", (event) => {
        if (event.touches.length === 2 && protocolImageZoom.pinchDistance) {
          event.preventDefault();
          const distance = protocolTouchDistance(event.touches);
          if (distance > 0) {
            const ratio = distance / protocolImageZoom.pinchDistance;
            setProtocolImageZoom(protocolImageZoom.pinchStartScale * ratio);
          }
          return;
        }
        if (event.touches.length === 1 && protocolImageZoom.dragging) {
          event.preventDefault();
          const nextX = event.touches[0].clientX;
          const nextY = event.touches[0].clientY;
          const dx = nextX - protocolImageZoom.lastX;
          const dy = nextY - protocolImageZoom.lastY;
          protocolImageZoom.lastX = nextX;
          protocolImageZoom.lastY = nextY;
          protocolImageZoom.x += dx;
          protocolImageZoom.y += dy;
          applyProtocolImageTransform();
        }
      }, { passive: false });
      el("protocolImageModalStage").addEventListener("touchend", (event) => {
        if (event.touches.length < 2) protocolImageZoom.pinchDistance = null;
        if (event.touches.length === 0) {
          protocolImageZoom.dragging = false;
          el("protocolImageModalImg").classList.remove("dragging");
        }
      });
      el("protocolImageModal").addEventListener("click", (event) => {
        if (event.target === el("protocolImageModal")) closeProtocolImageModal();
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeProtocolImageModal();
      });
    }

    function bootstrap() {
      el("fromDate").value = thirtyDaysAgoIsoDate();
      el("toDate").value = nowIsoDate();
      state.reportsPageSize = Number(el("pageSizeSelect").value || 50);
      bindEvents();
      updatePaginationUI();
      restoreSession();
    }

    bootstrap();
  </script>
</body>
</html>
