<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiLi - Painel de Auditoria Urbana</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 100%; min-height: 500px; border-radius: 16px; z-index: 1; }
        .status-badge { padding: 4px 10px; border-radius: 99px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-aberto { background: #DBEAFE; color: #1E40AF; }
        .status-resolvido { background: #DCFCE7; color: #166534; }
        .status-nao_resolvido { background: #FEE2E2; color: #991B1B; }
        
        /* Ajuste de responsividade total */
        .main-container { min-height: calc(100vh - 40px); display: flex; flex-direction: column; }
        
        /* Estiliza√ß√£o do Marcador Customizado (Cores do App) */
        .custom-pin {
            background-color: #10B981;
            border: 3px solid white;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            width: 30px !important;
            height: 30px !important;
        }

        [v-cloak] { display: none; }

        /* Card do App dentro do Mapa */
        .leaflet-popup-content-wrapper { border-radius: 16px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }
    </style>
</head>
<body class="bg-slate-50">

<div id="app" v-cloak class="p-4 md:p-8">
    <div v-if="!isLoggedIn" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-10 rounded-3xl shadow-2xl border border-slate-100 w-full max-w-md text-center">
            <div class="mb-6 flex justify-center">
                <div class="w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center shadow-lg shadow-emerald-200">
                    <span class="text-white text-3xl font-black">Ci</span>
                </div>
            </div>
            <h1 class="text-3xl font-black text-slate-800 mb-2">CiLi</h1>
            <p class="text-slate-400 font-bold text-xs uppercase tracking-widest mb-8">Gest√£o de Auditoria Urbana</p>
            
            <div class="space-y-4 text-left">
                <input v-model="loginForm.email" type="email" placeholder="E-mail" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 transition">
                <input v-model="loginForm.pass" @keyup.enter="handleLogin" type="password" placeholder="Senha" class="w-full px-5 py-4 bg-slate-50 border-none rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 transition">
                <button @click="handleLogin" :disabled="loading" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-black hover:bg-slate-700 transition transform active:scale-95 disabled:opacity-50">
                    {{ loading ? 'AUTENTICANDO...' : 'ENTRAR NO PAINEL' }}
                </button>
            </div>
        </div>
    </div>

    <div v-else class="main-container max-w-[1600px] mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-100">
                    <span class="text-white text-xl font-black">Ci</span>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-slate-800 leading-tight">CiLi <span class="text-emerald-500 text-xs font-bold px-2 py-1 bg-emerald-50 rounded-lg ml-2">BARRETOS</span></h1>
                    <p class="text-slate-400 text-[10px] font-black uppercase tracking-[3px]">Painel de Monitoramento</p>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 items-center">
                <div class="flex bg-white p-1 rounded-2xl shadow-sm border border-slate-200">
                    <input v-model="searchId" type="text" placeholder="Protocolo (Ex: CILI-123)" class="px-4 py-2 bg-transparent text-sm outline-none w-48 font-bold">
                    <button @click="checkProtocol" class="bg-slate-800 text-white px-6 py-2 rounded-xl text-xs font-black hover:bg-slate-700 transition">BUSCAR</button>
                </div>
                <button @click="handleLogout" class="bg-white p-3 rounded-2xl border border-slate-200 text-slate-400 hover:text-red-500 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
            <div v-for="(val, label) in stats" :key="label" class="bg-white p-6 rounded-[24px] shadow-sm border border-slate-100">
                <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-1">{{ label }}</p>
                <h2 class="text-4xl font-black text-slate-800">{{ val }}</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 flex-1">
            <aside class="lg:col-span-1">
                <div class="bg-white rounded-[24px] shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-5 border-bottom border-slate-50">
                        <h3 class="font-black text-slate-800 text-sm uppercase tracking-wider">Categorias</h3>
                    </div>
                    <div class="p-2 space-y-1 overflow-y-auto max-h-[500px]">
                        <button @click="filterCategory = 'all'" :class="filterCategory === 'all' ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-100' : 'text-slate-500 hover:bg-slate-50'" class="w-full flex items-center px-4 py-4 rounded-2xl transition group">
                            <span class="font-bold text-sm">Todas as Ocorr√™ncias</span>
                        </button>
                        
                        <button v-for="(icon, id) in categoryConfig" :key="id" 
                            @click="filterCategory = id" 
                            :class="filterCategory === id ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-100' : 'text-slate-600 hover:bg-slate-50'"
                            class="w-full flex items-center gap-3 px-4 py-4 rounded-2xl transition">
                            <div :class="filterCategory === id ? 'bg-white/20' : 'bg-emerald-50'" class="w-10 h-10 rounded-xl flex items-center justify-center">
                                <span class="text-lg">{{ getEmoji(id) }}</span>
                            </div>
                            <span class="font-bold text-sm text-left flex-1">{{ getLabel(id) }}</span>
                        </button>
                    </div>
                </div>
            </aside>

            <section class="lg:col-span-3 flex flex-col">
                <div class="bg-white p-2 rounded-[32px] shadow-sm border border-slate-200 flex-1 min-h-[600px]">
                    <div id="map"></div>
                </div>
            </section>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    // Configura√ß√µes do Supabase
    const _supabase = supabase.createClient('https://ngjuarfnlepwmvzmkukw.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nanVhcmZubGVwd212em1rdWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjI4NzcsImV4cCI6MjA4NDY5ODg3N30.w67LAEv_D6dn-N2IIGEBKbniwWNdDe7IuBEWptsEqC0');

    createApp({
        data() {
            return {
                isLoggedIn: false,
                loading: false,
                loginForm: { email: '', pass: '' },
                map: null,
                reports: [],
                markers: [],
                filterCategory: 'all',
                searchId: '',
                // Mapeamento vindo do seu c√≥digo do App
                categoryConfig: {
                    "pavi_vias": "Pavimenta√ß√£o e Vias",
                    "limpeza_urbana": "Limpeza Urbana",
                    "ilum_pub": "Ilumina√ß√£o P√∫blica",
                    "sinal_transito": "Sinaliza√ß√£o e Tr√¢nsito",
                    "areas_verdes": "√Åreas Verdes",
                    "poluicao_amb": "Polui√ß√£o Ambiental",
                    "saneamento": "Saneamento",
                    "mobilidade_urb": "Mobilidade Urbana",
                    "equip_pub": "Equipamentos P√∫blicos",
                    "seg_pub": "Seguran√ßa P√∫blica"
                }
            }
        },
        computed: {
            filteredReports() {
                if (this.filterCategory === 'all') return this.reports;
                return this.reports.filter(r => r.categoryId === this.filterCategory);
            },
            stats() {
                return {
                    "Total": this.reports.length,
                    "Resolvidos": this.reports.filter(r => r.status === 'resolvido').length,
                    "Em Aberto": this.reports.filter(r => r.status !== 'resolvido').length
                }
            }
        },
        watch: {
            filteredReports: { handler() { this.renderMarkers(); }, deep: true }
        },
        async mounted() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { this.isLoggedIn = true; this.$nextTick(() => this.initApp()); }
        },
        methods: {
            getEmoji(id) {
                const emojimap = { "pavi_vias": "üöß", "limpeza_urbana": "üßπ", "ilum_pub": "üí°", "sinal_transito": "üö•", "areas_verdes": "üå≥", "poluicao_amb": "üå´Ô∏è", "saneamento": "üíß", "mobilidade_urb": "üö≤", "equip_pub": "üè´", "seg_pub": "üõ°Ô∏è" };
                return emojimap[id] || "üìç";
            },
            getLabel(id) { return this.categoryConfig[id] || id; },

            async handleLogin() {
                this.loading = true;
                const { error } = await _supabase.auth.signInWithPassword({ email: this.loginForm.email, password: this.loginForm.pass });
                if (error) { alert("Acesso negado"); this.loading = false; }
                else { this.isLoggedIn = true; this.$nextTick(() => this.initApp()); }
            },

            async handleLogout() { await _supabase.auth.signOut(); location.reload(); },

            initApp() { this.initMap(); this.loadReports(); this.setupRealtime(); },

            initMap() {
                if (this.map) return;
                // Focado em Barretos - Ajuste fino de zoom
                this.map = L.map('map', { zoomControl: false }).setView([-20.557, -48.567], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'CiLi'
                }).addTo(this.map);
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);
            },

            async loadReports() {
                const { data } = await _supabase.from('public_map_reports').select('*');
                if (data) { this.reports = data; this.renderMarkers(); }
            },

            renderMarkers() {
                if (!this.map) return;
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                this.filteredReports.forEach(r => {
                    // √çcone customizado CORRIGIDO (Ancorado ao mapa)
                    const customIcon = L.divIcon({
                        className: 'custom-pin-container',
                        html: `<div class="custom-pin" style="background-color: ${r.status === 'resolvido' ? '#10B981' : '#3B82F6'}"></div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 30] // Garante que a ponta do PIN esteja na coordenada
                    });

                    const marker = L.marker([r.lat, r.lon], { icon: customIcon }).addTo(this.map);
                    
                    // Popup estilo "Card do App"
                    marker.bindPopup(`
                        <div class="rounded-2xl overflow-hidden">
                            ${r.image_url ? `<img src="${r.image_url}" class="w-full h-32 object-cover">` : '<div class="h-2 bg-emerald-500"></div>'}
                            <div class="p-4">
                                <span class="status-badge status-${(r.status || 'aberto').toLowerCase()}">${r.status || 'Aberto'}</span>
                                <h4 class="font-black text-slate-800 mt-2 text-lg">${r.categoryLabel}</h4>
                                <p class="text-slate-500 text-xs font-bold uppercase mt-1">ID: ${r.id}</p>
                                <hr class="my-3 border-slate-100">
                                <div class="flex justify-between items-center text-[10px] text-slate-400 font-bold uppercase tracking-wider">
                                    <span>${new Date(r.createdAt).toLocaleDateString()}</span>
                                    <span>BARRETOS-SP</span>
                                </div>
                            </div>
                        </div>
                    `);
                    this.markers.push(marker);
                });
            },

            setupRealtime() {
                _supabase.channel('db-ui').on('postgres_changes', { event: '*', schema: 'public', table: 'public_map_reports' }, () => this.loadReports()).subscribe();
            },

            async checkProtocol() {
                if(!this.searchId) return;
                // Busca inteligente: tenta pelo ID curto ou ID longo
                const cleanId = this.searchId.toUpperCase().trim();
                const { data } = await _supabase.from('reports')
                    .select('*')
                    .or(`id.eq.${cleanId},id.ilike.%${cleanId}%`)
                    .single();

                if(data) {
                    alert(`‚úÖ Protocolo Encontrado!\n\nStatus: ${data.status.toUpperCase()}\nCategoria: ${data.category_label}\nData: ${new Date(data.created_at).toLocaleString()}`);
                } else {
                    alert("‚ùå Protocolo n√£o localizado. Verifique se digitou corretamente (Ex: CILI-...)");
                }
            }
        }
    }).mount('#app')
</script>
</body>
</html>
