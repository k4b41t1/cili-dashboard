<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Acompanhamento CiLi</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        body, html { height: 100%; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        #app { height: 100vh; display: flex; flex-direction: column; }
        
        .main-content { flex: 1; display: grid; grid-template-columns: 320px 1fr; gap: 20px; padding: 20px; overflow: hidden; }
        #map { height: 100%; width: 100%; border-radius: 24px; z-index: 1; }
        
        .sidebar { background: white; border-radius: 24px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow: hidden; height: 100%; }
        .category-scroll { flex: 1; overflow-y: auto; padding: 10px; }

        /* Pins Customizados com Ponta no Local Exato */
        .pin-resolvido { background: #10B981; border: 3px solid white; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); width: 28px !important; height: 28px !important; }
        .pin-aberto { background: #3B82F6; border: 3px solid white; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); width: 28px !important; height: 28px !important; }

        /* Card Instagram Popup */
        .leaflet-popup-content-wrapper { border-radius: 20px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0 !important; width: 260px !important; }
        .insta-card-img { width: 100%; height: 260px; object-fit: cover; background: #f1f5f9; }
        
        /* Efeito de Clique nos Filtros de Status */
        .stat-card { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-card.active { border-color: currentColor; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50">

<div id="app" v-cloak>
    <div v-if="!isLoggedIn" class="h-full flex items-center justify-center">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-md text-center border border-slate-100">
            <img src="https://i.postimg.cc/8P6L8S9y/logo-cili.png" alt="CiLi Logo" class="h-24 mx-auto mb-8 object-contain">
            <h2 class="text-2xl font-black text-slate-800 mb-8 tracking-tight">Painel Administrativo</h2>
            <div class="space-y-4">
                <input v-model="loginForm.email" type="email" placeholder="E-mail" class="w-full px-6 py-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 font-medium">
                <input v-model="loginForm.pass" @keyup.enter="handleLogin" type="password" placeholder="Senha" class="w-full px-6 py-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-emerald-500 font-medium">
                <button @click="handleLogin" :disabled="loading" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black tracking-widest uppercase text-xs">
                    {{ loading ? 'VERIFICANDO...' : 'ENTRAR NO PAINEL' }}
                </button>
            </div>
        </div>
    </div>

    <template v-else>
        <header class="px-8 py-4 bg-white border-b border-slate-200 flex justify-between items-center shrink-0 shadow-sm z-10">
            <div class="flex items-center gap-5">
                <img src="https://i.postimg.cc/8P6L8S9y/logo-cili.png" alt="Logo" class="h-10 object-contain">
                <div class="h-8 w-[1px] bg-slate-200"></div>
                <h1 class="font-black text-slate-800 tracking-tighter text-xl uppercase">PAINEL DE ACOMPANHAMENTO <span class="text-emerald-500">CiLi</span></h1>
            </div>

            <div class="flex items-center gap-6">
                <div class="flex gap-3">
                    <div @click="statusFilter = 'all'" :class="['stat-card px-5 py-2 rounded-2xl bg-slate-100 text-slate-600', statusFilter === 'all' ? 'active' : '']">
                        <p class="text-[9px] font-black uppercase">Total</p>
                        <p class="text-xl font-black leading-none">{{ reports.length }}</p>
                    </div>
                    <div @click="statusFilter = 'resolvido'" :class="['stat-card px-5 py-2 rounded-2xl bg-emerald-50 text-emerald-600', statusFilter === 'resolvido' ? 'active' : '']">
                        <p class="text-[9px] font-black uppercase">Resolvidos</p>
                        <p class="text-xl font-black leading-none">{{ stats.resolvidos }}</p>
                    </div>
                    <div @click="statusFilter = 'aberto'" :class="['stat-card px-5 py-2 rounded-2xl bg-blue-50 text-blue-600', statusFilter === 'aberto' ? 'active' : '']">
                        <p class="text-[9px] font-black uppercase">Em Aberto</p>
                        <p class="text-xl font-black leading-none">{{ stats.abertos }}</p>
                    </div>
                </div>
                <button @click="handleLogout" class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-slate-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
        </header>

        <main class="main-content">
            <aside class="sidebar">
                <div class="p-6 border-b border-slate-50">
                    <h3 class="font-black text-slate-400 text-[10px] uppercase tracking-[2px]">Categorias do App</h3>
                </div>
                <div class="category-scroll">
                    <button @click="filterCategory = 'all'" :class="filterCategory === 'all' ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-500 hover:bg-slate-50'" class="w-full flex items-center px-5 py-4 rounded-2xl transition-all duration-300 mb-3">
                        <span class="font-bold text-sm">Todas as categorias</span>
                    </button>
                    
                    <button v-for="(label, id) in categoryConfig" :key="id" 
                        @click="filterCategory = id" 
                        :class="filterCategory === id ? 'bg-emerald-500 text-white shadow-lg' : 'text-slate-600 hover:bg-slate-50'"
                        class="w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-200 mb-2">
                        <div :class="filterCategory === id ? 'bg-white/20 text-white' : 'bg-emerald-50 text-emerald-600'" class="w-10 h-10 rounded-xl flex items-center justify-center shrink-0">
                            <span class="text-xl">{{ getEmoji(id) }}</span>
                        </div>
                        <span class="font-bold text-[13px] text-left leading-tight flex-1">{{ label }}</span>
                    </button>
                </div>
            </aside>

            <section class="relative">
                <div id="map"></div>
                <div class="absolute top-6 left-6 z-[1000] bg-white/90 backdrop-blur-md p-2 rounded-2xl shadow-2xl flex border border-white">
                    <input v-model="searchId" type="text" placeholder="ID ou Protocolo..." class="px-5 py-3 text-sm outline-none w-56 font-bold bg-transparent">
                    <button @click="checkProtocol" class="bg-slate-900 text-white px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-wider">BUSCAR</button>
                </div>
            </section>
        </main>
    </template>
</div>

<script>
    const { createApp } = Vue;
    // CONFIGURA√á√ÉO SUPABASE
    const _supabase = supabase.createClient('https://ngjuarfnlepwmvzmkukw.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5nanVhcmZubGVwd212em1rdWt3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMjI4NzcsImV4cCI6MjA4NDY5ODg3N30.w67LAEv_D6dn-N2IIGEBKbniwWNdDe7IuBEWptsEqC0');

    createApp({
        data() {
            return {
                isLoggedIn: false,
                loading: false,
                loginForm: { email: '', pass: '' },
                map: null,
                reports: [],
                markers: [],
                filterCategory: 'all',
                statusFilter: 'all',
                searchId: '',
                categoryConfig: {
                    "pavi_vias": "Pavimenta√ß√£o e Vias",
                    "limpeza_urbana": "Limpeza Urbana",
                    "ilum_pub": "Ilumina√ß√£o P√∫blica",
                    "sinal_transito": "Sinaliza√ß√£o e Tr√¢nsito",
                    "areas_verdes": "√Åreas Verdes",
                    "poluicao_amb": "Polui√ß√£o Ambiental",
                    "saneamento": "Saneamento",
                    "mobilidade_urb": "Mobilidade Urbana",
                    "equip_pub": "Equipamentos P√∫blicos",
                    "seg_pub": "Seguran√ßa P√∫blica"
                }
            }
        },
        computed: {
            filteredReports() {
                // L√ìGICA DE FILTRO CRUZADO (CATEGORIA + STATUS)
                return this.reports.filter(r => {
                    const matchCategory = (this.filterCategory === 'all' || r.categoryId === this.filterCategory);
                    const isResolvido = r.status === 'resolvido';
                    const matchStatus = (this.statusFilter === 'all') || 
                                       (this.statusFilter === 'resolvido' && isResolvido) || 
                                       (this.statusFilter === 'aberto' && !isResolvido);
                    return matchCategory && matchStatus;
                });
            },
            stats() {
                return {
                    resolvidos: this.reports.filter(r => r.status === 'resolvido').length,
                    abertos: this.reports.filter(r => r.status !== 'resolvido').length
                }
            }
        },
        watch: {
            filteredReports: { handler() { this.renderMarkers(); }, deep: true }
        },
        async mounted() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (session) { this.isLoggedIn = true; this.$nextTick(() => this.initApp()); }
        },
        methods: {
            getEmoji(id) {
                const map = { "pavi_vias": "üöß", "limpeza_urbana": "üßπ", "ilum_pub": "üí°", "sinal_transito": "üö•", "areas_verdes": "üå≥", "poluicao_amb": "üå´Ô∏è", "saneamento": "üíß", "mobilidade_urb": "üö≤", "equip_pub": "üè´", "seg_pub": "üõ°Ô∏è" };
                return map[id] || "üìç";
            },
            async handleLogin() {
                this.loading = true;
                const { error } = await _supabase.auth.signInWithPassword({ email: this.loginForm.email, password: this.loginForm.pass });
                if (error) { alert("Acesso n√£o autorizado."); this.loading = false; }
                else { this.isLoggedIn = true; this.$nextTick(() => this.initApp()); }
            },
            handleLogout() { _supabase.auth.signOut(); location.reload(); },
            initApp() { this.initMap(); this.loadReports(); this.setupRealtime(); },
            initMap() {
                if (this.map) return;
                this.map = L.map('map', { zoomControl: false }).setView([-20.557, -48.567], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(this.map);
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);
            },
            async loadReports() {
                const { data } = await _supabase.from('public_map_reports').select('*');
                if (data) { this.reports = data; this.renderMarkers(); }
            },
            renderMarkers() {
                if (!this.map) return;
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                this.filteredReports.forEach(r => {
                    const iconClass = r.status === 'resolvido' ? 'pin-resolvido' : 'pin-aberto';
                    const icon = L.divIcon({
                        className: 'cili-marker',
                        html: `<div class="${iconClass}"></div>`,
                        iconSize: [28, 28],
                        iconAnchor: [14, 28]
                    });

                    const marker = L.marker([r.lat, r.lon], { icon }).addTo(this.map);
                    marker.bindPopup(`
                        <div class="insta-card">
                            <img src="${r.image_url || 'https://via.placeholder.com/400x400?text=CiLi+Barretos'}" class="insta-card-img">
                            <div class="p-5">
                                <div class="flex items-center justify-between mb-3">
                                    <span class="px-2 py-1 rounded-md text-[9px] font-black uppercase ${r.status === 'resolvido' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'}">
                                        ${r.status || 'Em Aberto'}
                                    </span>
                                    <span class="text-[9px] font-bold text-slate-300">#${r.id.slice(-6)}</span>
                                </div>
                                <h4 class="font-black text-slate-800 text-base leading-tight">${r.categoryLabel}</h4>
                                <div class="mt-5 pt-3 border-t border-slate-50 flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                    <span>${new Date(r.createdAt).toLocaleDateString()}</span>
                                    <span class="text-emerald-500">Barretos</span>
                                </div>
                            </div>
                        </div>
                    `);
                    this.markers.push(marker);
                });
            },
            setupRealtime() {
                _supabase.channel('db').on('postgres_changes', { event: '*', schema: 'public', table: 'public_map_reports' }, () => this.loadReports()).subscribe();
            },
            async checkProtocol() {
                if(!this.searchId) return;
                const { data } = await _supabase.from('reports').select('*').ilike('id', `%${this.searchId}%`).single();
                if(data) alert(`‚úÖ Protocolo Localizado!\nStatus: ${data.status}\nCategoria: ${data.category_label}`);
                else alert("‚ùå Protocolo n√£o encontrado em nossa base.");
            }
        }
    }).mount('#app')
</script>
</body>
</html>
