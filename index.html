<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CiLi - Painel de Auditoria Urbana</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; border-radius: 12px; z-index: 1; }
        .status-badge { padding: 2px 8px; border-radius: 99px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .status-enviado { background: #DBEAFE; color: #1E40AF; }
        .status-aberto { background: #DBEAFE; color: #1E40AF; }
        .status-resolvido { background: #DCFCE7; color: #166534; }
        .status-nao_resolvido { background: #FEE2E2; color: #991B1B; }
    </style>
</head>
<body class="bg-slate-50 font-sans">

<div id="app" class="max-w-6xl mx-auto p-4">
    <header class="flex justify-between items-center mb-8 py-4">
        <div>
            <h1 class="text-2xl font-black text-slate-800">CiLi <span class="text-emerald-500 text-sm">PAINEL PÚBLICO</span></h1>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">Barretos - SP</p>
        </div>
        <div class="flex gap-2">
            <input v-model="searchId" type="text" placeholder="Protocolo..." class="px-4 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-500">
            <button @click="checkProtocol" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold">Buscar</button>
        </div>
    </header>

    <main class="grid grid-cols-1 gap-6">
        <div class="bg-white p-2 rounded-2xl shadow-sm border border-slate-200">
            <div id="map"></div>
        </div>
    </main>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<script>
    const { createApp } = Vue;
    const supabase = Object.assign(supabase.createClient('SUA_URL', 'SUA_ANON_KEY'));

    createApp({
        data() {
            return {
                map: null,
                reports: [],
                searchId: '',
                markers: []
            }
        },
        mounted() {
            this.initMap();
            this.loadReports();
            this.setupRealtime(); // Ativa a atualização automática
        },
        methods: {
            initMap() {
                // Focado em Barretos
                this.map = L.map('map').setView([-20.557, -48.567], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(this.map);
            },

            async loadReports() {
                const { data, error } = await supabase
                    .from('public_map_reports')
                    .select('*');

                if (error) return console.error(error);
                
                // Limpa marcadores existentes para não duplicar no reload
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];

                data.forEach(r => {
                    const marker = L.marker([r.lat, r.lon])
                     .addTo(this.map)
                     .bindPopup(`
                        <div style="font-family: sans-serif; min-width: 150px">
                            <b style="font-size: 14px; color: #1e293b">${r.categoryLabel}</b><br>
                            <div style="margin: 8px 0">
                                <span class="status-badge status-${(r.status || 'aberto').toLowerCase()}">${r.status || 'Aberto'}</span>
                            </div>
                            <small style="color: #64748b">${new Date(r.createdAt).toLocaleDateString('pt-BR')} às ${new Date(r.createdAt).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</small>
                        </div>
                     `);
                    this.markers.push(marker);
                });
            },

            setupRealtime() {
                // Escuta inserções e atualizações na tabela pública
                supabase
                    .channel('map-updates')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'public_map_reports' }, 
                        (payload) => {
                            console.log("Mudança detectada no banco:", payload);
                            this.loadReports(); 
                        }
                    )
                    .subscribe();
            },

            async checkProtocol() {
                if(!this.searchId) return;
                const { data, error } = await supabase
                    .from('reports') // Busca na tabela principal para mais detalhes
                    .select('*')
                    .eq('id', this.searchId)
                    .single();

                if(data) {
                    alert(`Protocolo: ${data.id}\nStatus: ${data.status}\nCategoria: ${data.category_label}\nData: ${new Date(data.created_at).toLocaleDateString()}`);
                } else {
                    alert("Protocolo não encontrado ou ainda processando.");
                }
            }
        }
    }).mount('#app')
</script>
</body>
</html>
